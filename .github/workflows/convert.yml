name: Update PrivateTracker MRS

on:
  workflow_dispatch:
  schedule:
    # æ¯ 7 å¤©è·‘ä¸€æ¬¡ï¼ˆUTC 0 ç‚¹ï¼‰
    - cron: "0 0 */7 * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Download source YAML
        run: |
          curl -L "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PrivateTracker/PrivateTracker.yaml" -o PrivateTracker.yaml

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download and install Mihomo
        run: |
          set -e
          echo "Fetching latest mihomo release info..."

          # æ‹‰æœ€æ–° release çš„ JSON
          json=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)

          # ä» assets é‡Œæ‰¾å‡ºå¸¦ linux-amd64 ä¸”ä»¥ .gz ç»“å°¾çš„æ–‡ä»¶å
          asset_name=$(echo "$json" | jq -r '.assets[].name | select(contains("linux-amd64") and endswith(".gz"))' | head -n 1)

          if [ -z "$asset_name" ]; then
            echo "âŒ æ²¡æ‰¾åˆ° linux-amd64 çš„ .gz èµ„äº§ï¼Œå½“å‰ assets åˆ—è¡¨ï¼š"
            echo "$json" | jq -r '.assets[].name'
            exit 1
          fi

          # æ ¹æ®æ–‡ä»¶åå–ä¸‹è½½åœ°å€
          download_url=$(echo "$json" | jq -r ".assets[] | select(.name==\"$asset_name\") | .browser_download_url")

          echo "âœ… é€‰æ‹©çš„èµ„äº§ï¼š$asset_name"
          echo "ğŸ”— ä¸‹è½½åœ°å€ï¼š$download_url"

          curl -L "$download_url" -o mihomo.gz
          gunzip mihomo.gz

          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/mihomo

          echo "Mihomo version:"
          mihomo -v

      - name: Convert YAML to MRS
        run: |
          set -e
          mkdir -p mrs
          mihomo convert-ruleset domain yaml ./PrivateTracker.yaml ./mrs/PrivateTracker.mrs

      - name: Commit and Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -q "mrs/PrivateTracker.mrs"; then
            git add mrs/PrivateTracker.mrs
            git commit -m "Update PrivateTracker.mrs"
            git push
          else
            echo "No changes in mrs/PrivateTracker.mrs, skip commit."
          fi
