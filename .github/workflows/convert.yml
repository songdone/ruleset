name: Update PrivateTracker MRS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */7 * *"   # æ¯ 7 å¤©æ›´æ–°

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ğŸ”¥ æœ€å…³é”®ï¼šå…è®¸ push

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download source YAML
        run: |
          mkdir -p sources
          curl -L \
            -o sources/PrivateTracker.yaml \
            https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PrivateTracker/PrivateTracker.yaml

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download and install Mihomo
        run: |
          set -e
          echo "Fetching latest mihomo release info..."

          json=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)

          asset_name=$(echo "$json" | jq -r '.assets[].name | select(contains("linux-amd64") and endswith(".gz"))' | head -n 1)
          download_url=$(echo "$json" | jq -r ".assets[] | select(.name==\"$asset_name\") | .browser_download_url")

          echo "Using asset: $asset_name"
          echo "URL: $download_url"

          curl -L "$download_url" -o mihomo.gz
          gunzip mihomo.gz

          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/mihomo

      - name: Convert YAML to MRS
        run: |
          mkdir -p mrs
          mihomo convert-ruleset domain yaml \
            sources/PrivateTracker.yaml \
            mrs/PrivateTracker.mrs

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add mrs/PrivateTracker.mrs sources/PrivateTracker.yaml

          git commit -m "Update PrivateTracker.mrs" || echo "No changes"
          git push origin main
